@model IEnumerable<capstone.Models.MaintenanceHistory>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Management | Admin Dashboard – SafeCycle</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4da6ff;
            --primary-dark: #0066cc;
            --primary-light: #e6f2ff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --white: #ffffff;
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 70px;
            --topbar-height: 60px;
            --card-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        /* Layout Structure */
        .layout-wrapper {
            display: flex;
            min-height: 100vh;
        }
        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--white);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            transition: width var(--transition-speed);
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }

            .sidebar.collapsed {
                width: var(--sidebar-width-collapsed);
            }

        .sidebar-brand {
            height: var(--topbar-height);
            display: flex;
            align-items: center;
            padding: 0 20px;
            background-color: var(--primary-color);
            color: var(--white);
        }

            .sidebar-brand h1 {
                font-size: 1.5rem;
                font-weight: 600;
                white-space: nowrap;
                overflow: hidden;
                margin: 0;
            }

        .sidebar-brand-icon {
            font-size: 1.8rem;
            margin-right: 15px;
        }

        .sidebar-menu {
            padding: 15px 0;
        }

        .sidebar-heading {
            color: var(--secondary-color);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 15px 20px 5px;
        }

        .sidebar-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            color: var(--secondary-color);
            text-decoration: none;
            transition: all var(--transition-speed);
            position: relative;
        }

            .sidebar-item i {
                min-width: 30px;
                font-size: 1.1rem;
            }

        .sidebar-item-text {
            white-space: nowrap;
            overflow: hidden;
            transition: opacity var(--transition-speed);
        }

        .collapsed .sidebar-item-text {
            opacity: 0;
            width: 0;
        }

        .sidebar-item:hover, .sidebar-item.active {
            color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .sidebar-item.active {
            border-left: 4px solid var(--primary-color);
        }

        .sidebar-item .badge {
            position: absolute;
            right: 20px;
            background-color: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            padding: 3px 6px;
            border-radius: 10px;
        }

        .sidebar-toggle {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: var(--primary-light);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

            .sidebar-toggle:hover {
                background-color: var(--primary-color);
                color: var(--white);
            }
        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left var(--transition-speed);
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: var(--sidebar-width-collapsed);
        }
        /* Mobile menu toggle */
        .menu-toggle {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 999;
            background-color: var(--primary-color);
            color: var(--white);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        /* Responsive styles for sidebar */
        @@media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 1001;
            }

                .sidebar.mobile-active {
                    transform: translateX(0);
                }

            .main-content {
                margin-left: 0 !important;
            }

            .menu-toggle {
                display: flex;
            }
        }

        /* Page styles from original code */
        .breadcrumb-item a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .page-header {
            background-color: white;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 1rem 0;
        }

        .nav-tabs .nav-link {
            color: var(--dark-color);
            font-weight: 500;
        }

            .nav-tabs .nav-link.active {
                color: var(--primary-color);
                border-bottom: 2px solid var(--primary-color);
            }

        .dashboard-card {
            background-color: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

            .dashboard-card:hover {
                transform: translateY(-3px);
            }

        .card-icon {
            background-color: rgba(77, 166, 255, 0.1);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }

        .card-title {
            color: var(--dark-color);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .card-value {
            color: var(--dark-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .filters-panel {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .table-card {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .table th {
            font-weight: 500;
            color: var(--dark-color);
            border-top: none;
            border-bottom: 1px solid #e9ecef;
        }

        .badge-active {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            padding: 0.4rem 0.7rem;
        }

        .badge-inactive {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            padding: 0.4rem 0.7rem;
        }

        .action-icon {
            color: var(--primary-color);
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

            .btn-primary:hover {
                background-color: #3d96e8;
                border-color: #3d96e8;
            }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

            .btn-outline-primary:hover {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
            }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: var(--primary-color);
        }

        .modal-header {
            background-color: var(--primary-color);
            color: white;
        }

        .close {
            color: white;
        }

        .form-label {
            font-weight: 500;
        }

        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .pagination .page-link {
            color: var(--primary-color);
        }
        /* Custom toggle switch */
        .form-switch .form-check-input:checked {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
    </style>
</head>
<body>
    <div class="layout-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-recycle sidebar-brand-icon"></i>
                <h1 class="sidebar-brand-text">SafeCycle</h1>
            </div>
            <div class="sidebar-menu">
                <div class="sidebar-heading">Main</div>
                <a href="~/Admin/admindashboard" class="sidebar-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="sidebar-item-text">Dashboard</span>
                </a>
                <a href="~/Admin/machineManagmentAdmin" class="sidebar-item">
                    <i class="fas fa-cogs"></i>
                    <span class="sidebar-item-text">Machine Management</span>
                    <span class="badge">4</span>
                </a>
                <a href="~/MaintenanceAdmin/MaintenanceAdminDshboard" class="sidebar-item active">
                    <i class="fas fa-tools"></i>
                    <span class="sidebar-item-text">Maintenance</span>
                    <span class="badge">7</span>
                </a>
                <a href="~/WorkerAdmin/WorkerAdminDashboard" class="sidebar-item">
                    <i class="fas fa-users"></i>
                    <span class="sidebar-item-text">Workers / Technicians</span>
                </a>
                <a href="~/SparePartsAdmin/SparePartsAdminDashboard" class="sidebar-item">
                    <i class="fas fa-boxes"></i>
                    <span class="sidebar-item-text">Spare Parts Inventory</span>
                    <span class="badge">3</span>
                </a>
                <div class="sidebar-heading">Records</div>
                <a href="~/CleaningLogs/CleaningLogsAdminDashboard" class="sidebar-item">
                    <i class="fas fa-clipboard-list"></i>
                    <span class="sidebar-item-text">Cleaning Logs</span>
                </a>
                <div class="sidebar-heading">System</div>
                <a href="~/SystemSettingsAdmin/SystemSettings" class="sidebar-item">
                    <i class="fas fa-cog"></i>
                    <span class="sidebar-item-text">System Settings</span>
                </a>
            </div>
            <div class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </div>
        </aside>

        <!-- Mobile Menu Toggle -->
        <div class="menu-toggle" id="menu-toggle">
            <i class="fas fa-bars"></i>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header Section -->
            <header class="page-header">
                <div class="container">
                    <div class="row align-items-center">
                        <div class="col-lg-6">
                            <h1 class="h4 mb-1">Maintenance Management</h1>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb small mb-0">
                                    <li class="breadcrumb-item"><a href="~/Admin/machineManagmentAdmin">Dashboard</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Maintenance Management</li>
                                </ol>
                            </nav>
                        </div>
                        <div class="col-lg-6 text-end">
                            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addMaintenanceModal">
                                <i class="fas fa-plus me-1"></i> Add Maintenance Request
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Container Content -->
            <div class="container py-4">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-4" id="maintenanceTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" aria-selected="true">
                            <i class="fas fa-tools me-1"></i> All Requests (12)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-selected="false">
                            <i class="fas fa-hourglass-half me-1"></i> Pending (4)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="in-progress-tab" data-bs-toggle="tab" data-bs-target="#in-progress" type="button" role="tab" aria-selected="false">
                            <i class="fas fa-sync-alt me-1"></i> In Progress (5)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab" aria-selected="false">
                            <i class="fas fa-check-circle me-1"></i> Completed (3)
                        </button>
                    </li>
                </ul>

                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="dashboard-card p-3">
                            <div class="d-flex align-items-center">
                                <div class="card-icon me-3">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <div>
                                    <div class="card-title text-muted mb-0">Total Requests</div>
                                    <div class="card-value">12</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="dashboard-card p-3">
                            <div class="d-flex align-items-center">
                                <div class="card-icon me-3">
                                    <i class="fas fa-hourglass-half"></i>
                                </div>
                                <div>
                                    <div class="card-title text-muted mb-0">Pending</div>
                                    <div class="card-value">4</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="dashboard-card p-3">
                            <div class="d-flex align-items-center">
                                <div class="card-icon me-3">
                                    <i class="fas fa-sync-alt"></i>
                                </div>
                                <div>
                                    <div class="card-title text-muted mb-0">In Progress</div>
                                    <div class="card-value">5</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="dashboard-card p-3">
                            <div class="d-flex align-items-center">
                                <div class="card-icon me-3">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div>
                                    <div class="card-title text-muted mb-0">Completed</div>
                                    <div class="card-value">3</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters Panel -->
                <div class="filters-panel mb-4">
                    <div class="row align-items-center">
                        <div class="col-lg-4 mb-3 mb-lg-0">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-start-0" id="searchRequests" placeholder="Search maintenance requests...">
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                                <div class="me-2">
                                    <select class="form-select" id="filterMachine">
                                        <option value="">Machine: All</option>
                                        <option value="machine-a">Machine A</option>
                                        <option value="machine-b">Machine B</option>
                                        <option value="machine-c">Machine C</option>
                                    </select>
                                </div>
                                <div class="me-2">
                                    <select class="form-select" id="filterStatus">
                                        <option value="">Status: All</option>
                                        <option value="pending">Pending</option>
                                        <option value="in-progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <div class="me-2">
                                    <select class="form-select" id="filterLocation">
                                        <option value="">Location: All</option>
                                        <option value="site-a">Site A</option>
                                        <option value="site-b">Site B</option>
                                        <option value="warehouse">Warehouse</option>
                                    </select>
                                </div>
                                <button class="btn btn-outline-primary" id="resetFilters">
                                    <i class="fas fa-sync-alt me-1"></i> Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content with Tables -->
                <div class="tab-content" id="maintenanceTabContent">
                    <!-- All Requests Tab -->
                    <div class="tab-pane fade show active" id="all" role="tabpanel">
                        <div class="table-card">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle" id="allRequestsTable">
                                    <thead>
                                        <tr>
                                            <th scope="col">Request ID</th>
                                            <th scope="col">Machine</th>
                                            <th scope="col">Repair Details</th>
                                            <th scope="col">Date</th>
                                            <th scope="col" class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var x in Model)
                                        {
                                            <tr>
                                                <td>@x.HistoryID</td>
                                                <td>@x.MachineID</td>
                                                <td>@x.RepairDetails</td>
                                                <td>@x.CompletionDate</td>
                                                <td class="text-end">
                                                    <button type="button" class="btn btn-sm btn-primary" onclick="openEditModal(@x.HistoryID)">Edit</button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="small text-muted">Showing @Model.Count() of @Model.Count() entries</div>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Requests Tab -->
                    <div class="tab-pane fade" id="pending" role="tabpanel">
                        <div class="table-card">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle" id="pendingRequestsTable">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 40px;"><input type="checkbox" class="form-check-input" id="selectAllPending"></th>
                                            <th scope="col">Request ID</th>
                                            <th scope="col">Machine</th>
                                            <th scope="col">Issue Description</th>
                                            <th scope="col">Reported By</th>
                                            <th scope="col">Date</th>
                                            <th scope="col" class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="checkbox" class="form-check-input request-checkbox"></td>
                                            <td>REQ-001</td>
                                            <td>CNC Milling Machine</td>
                                            <td>Spindle overheating</td>
                                            <td>John Doe</td>
                                            <td>2023-10-01</td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-primary btn-assign" data-id="REQ-001" data-machine="CNC Milling Machine" data-issue="Spindle overheating"><i class="fas fa-tasks me-1"></i>Assign</button>
                                                <button class="btn btn-sm btn-outline-secondary btn-edit" data-id="REQ-001"><i class="fas fa-pen me-1"></i>Edit</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- In Progress Tab -->
                    <div class="tab-pane fade" id="in-progress" role="tabpanel">
                        <div class="table-card">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle" id="inProgressRequestsTable">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 40px;"><input type="checkbox" class="form-check-input" id="selectAllInProgress"></th>
                                            <th scope="col">Request ID</th>
                                            <th scope="col">Machine</th>
                                            <th scope="col">Issue Description</th>
                                            <th scope="col">Assigned To</th>
                                            <th scope="col">Date</th>
                                            <th scope="col" class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="checkbox" class="form-check-input request-checkbox"></td>
                                            <td>REQ-002</td>
                                            <td>Laser Cutter</td>
                                            <td>Beam misalignment</td>
                                            <td>Maria Parker</td>
                                            <td>2023-10-02</td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-success"><i class="fas fa-check me-1"></i>Mark Complete</button>
                                                <button class="btn btn-sm btn-outline-secondary btn-edit" data-id="REQ-002"><i class="fas fa-pen me-1"></i>Edit</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Completed Tab -->
                    <div class="tab-pane fade" id="completed" role="tabpanel">
                        <div class="table-card">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle" id="completedRequestsTable">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 40px;"><input type="checkbox" class="form-check-input" id="selectAllCompleted"></th>
                                            <th scope="col">Request ID</th>
                                            <th scope="col">Machine</th>
                                            <th scope="col">Issue Description</th>
                                            <th scope="col">Completed By</th>
                                            <th scope="col">Completion Date</th>
                                            <th scope="col" class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="checkbox" class="form-check-input request-checkbox"></td>
                                            <td>REQ-003</td>
                                            <td>3D Printer</td>
                                            <td>Extruder clogged</td>
                                            <td>Anna Smith</td>
                                            <td>2023-09-28</td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-info"><i class="fas fa-file-alt me-1"></i>View Report</button>
                                                <button class="btn btn-sm btn-outline-secondary btn-edit" data-id="REQ-003"><i class="fas fa-pen me-1"></i>Edit</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Maintenance Request Modal -->
    <div class="modal fade" id="addMaintenanceModal" tabindex="-1" aria-labelledby="addMaintenanceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addMaintenanceModalLabel">Add New Maintenance Request</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form asp-action="Create" asp-controller="MaintenanceAdmin" id="addMaintenanceForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="MachineID" class="form-label">Machine ID</label>
                                <input type="number" class="form-control" name="MachineID" id="MachineID" required>
                            </div>
                            <div class="col-md-6">
                                <label for="RepairDetails" class="form-label">Repair Details</label>
                                <input type="text" class="form-control" name="RepairDetails" id="RepairDetails" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="CompletionDate" class="form-label">Date</label>
                                <input type="datetime-local" name="CompletionDate" class="form-control" id="CompletionDate" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="saveRequest">Save Request</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Task Modal -->
    <div class="modal fade" id="assignTaskModal" tabindex="-1" aria-labelledby="assignTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="assignTaskModalLabel">Assign Task</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="assignTaskForm">
                        <div class="mb-3">
                            <label class="form-label">Request Details</label>
                            <div class="d-flex align-items-center">
                                <div class="avatar me-2">MC</div>
                                <div>
                                    <div class="fw-bold" id="assignRequestMachine">Machine Name</div>
                                    <div class="small text-muted" id="assignRequestIssue">Issue Description</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="assignedTechnician" class="form-label">Assign To</label>
                            <select class="form-select" id="assignedTechnician" required>
                                <option value="">Select Technician</option>
                                <option value="technician-a">Anna Smith</option>
                                <option value="technician-b">Maria Parker</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="taskDuration" class="form-label">Estimated Duration</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="taskDuration" min="1" value="1">
                                <span class="input-group-text">hours</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="taskNotes" class="form-label">Instructions/Notes</label>
                            <textarea class="form-control" id="taskNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAssignment">Assign Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Request Modal -->
    <div class="modal fade" id="editRequestModal" tabindex="-1" aria-labelledby="editRequestModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editRequestModalLabel">Edit Maintenance Request</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editRequestForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="HistoryID" id="editHistoryID" />
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editMachineID" class="form-label">Machine ID</label>
                                <input type="number" class="form-control" name="MachineID" id="editMachineID" required min="1">
                                <span class="text-danger validation-message" data-for="MachineID"></span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="editRepairDetails" class="form-label">Repair Details</label>
                                <textarea class="form-control" name="RepairDetails" id="editRepairDetails" rows="3" required></textarea>
                                <span class="text-danger validation-message" data-for="RepairDetails"></span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editCompletionDate" class="form-label">Date</label>
                                <input type="datetime-local" name="CompletionDate" class="form-control" id="editCompletionDate" required>
                                <span class="text-danger validation-message" data-for="CompletionDate"></span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="updateRequest">Update Request</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Maintenance Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="reportModalLabel">Maintenance Report</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-4">
                        <div>
                            <h5 id="reportMachine">Machine Name</h5>
                            <p class="text-muted mb-0" id="reportIssue">Issue Description</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success">Completed</span>
                            <p class="small text-muted mb-0">Report ID: <span id="reportId">REP-001</span></p>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6>Request Details</h6>
                                    <div class="mb-2">
                                        <span class="text-muted">Reported By:</span>
                                        <span class="ms-2" id="reportRequester">John Doe</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-muted">Request Date:</span>
                                        <span class="ms-2" id="reportDate">2023-10-01</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-muted">Completion Date:</span>
                                        <span class="ms-2" id="reportCompletionDate">2023-10-05</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6>Service Details</h6>
                                    <div class="mb-2">
                                        <span class="text-muted">Technician:</span>
                                        <span class="ms-2" id="reportTechnician">Anna Smith</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-muted">Total Hours:</span>
                                        <span class="ms-2" id="reportHours">3.5 hours</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-muted">Parts Used:</span>
                                        <span class="ms-2" id="reportParts">Spindle Bearing, Cooling Fan</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h6>Description of Work</h6>
                        <p id="reportDescription">The machine's spindle was overheating due to a worn bearing and malfunctioning cooling fan. Replaced the bearing and installed a new cooling fan. Cleaned all surrounding components and tested for proper operation. Machine is now functioning within normal temperature ranges.</p>
                    </div>
                    <div class="mb-4">
                        <h6>Recommendations</h6>
                        <p id="reportRecommendations">Schedule regular maintenance checks every 3 months to prevent future issues. Monitor temperature readings daily and report any abnormal readings immediately.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary"><i class="fas fa-print me-1"></i> Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const menuToggle = document.getElementById('menu-toggle');
        const assignButtons = document.querySelectorAll('.btn-assign');
        const editButtons = document.querySelectorAll('.btn-edit');
        const selectAllCheckbox = document.getElementById('selectAllPending');
        const requestCheckboxes = document.querySelectorAll('.request-checkbox');
        const searchInput = document.getElementById('searchRequests');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const saveRequestBtn = document.getElementById('saveRequest');
        const saveAssignmentBtn = document.getElementById('saveAssignment');
        const updateRequestBtn = document.getElementById('updateRequest');

        // Sidebar Toggle
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            const icon = this.querySelector('i');
            if (sidebar.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        });

        // Mobile Menu Toggle
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('mobile-active');
        });

        // Select All Checkboxes
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                requestCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        }

        // Client-side validation for edit form
        function validateEditForm() {
            const machineID = document.getElementById('editMachineID').value;
            const repairDetails = document.getElementById('editRepairDetails').value;
            const completionDate = document.getElementById('editCompletionDate').value;

            let isValid = true;
            document.querySelectorAll('.validation-message').forEach(el => el.textContent = '');

            if (!machineID || machineID <= 0) {
                document.querySelector('[data-for="MachineID"]').textContent = 'معرف الماكينة مطلوب ويجب أن يكون رقمًا صحيحًا موجبًا.';
                isValid = false;
            }
            if (!repairDetails.trim()) {
                document.querySelector('[data-for="RepairDetails"]').textContent = 'تفاصيل الإصلاح مطلوبة.';
                isValid = false;
            }
            if (!completionDate) {
                document.querySelector('[data-for="CompletionDate"]').textContent = 'تاريخ الإكمال مطلوب.';
                isValid = false;
            }

            return isValid;
        }

        // Function to open edit modal and populate data
        function openEditModal(historyID) {
            fetch(`/MaintenanceAdmin/Edit/${historyID}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.message || 'فشل جلب بيانات الصيانة');
                    }
                    // Format the date for datetime-local input
                    const completionDate = data.completionDate ? data.completionDate : '';
                    // Populate form fields
                    document.getElementById('editHistoryID').value = data.historyID;
                    document.getElementById('editMachineID').value = data.machineID;
                    document.getElementById('editRepairDetails').value = data.repairDetails;
                    document.getElementById('editCompletionDate').value = completionDate;
                    // Clear previous validation messages
                    document.querySelectorAll('.validation-message').forEach(el => el.textContent = '');
                    // Show the modal
                    const editModal = new bootstrap.Modal(document.getElementById('editRequestModal'));
                    editModal.show();
                })
                .catch(error => {
                    console.error('Error fetching maintenance data:', error);
                    alert('خطأ في تحميل بيانات الصيانة: ' + error.message);
                });
        }

        // Handle form submission for update
        if (updateRequestBtn) {
            updateRequestBtn.addEventListener('click', function() {
                const form = document.getElementById('editRequestForm');

                // Validate form client-side
                if (!validateEditForm()) {
                    return;
                }

                const formData = new FormData(form);
                // Log FormData for debugging
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                fetch('/MaintenanceAdmin/Update', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error! Status: ${response.status}, Response: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Maintenance request updated successfully!');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editRequestModal'));
                        modal.hide();
                        location.reload();
                    } else {
                        alert('خطأ: ' + (data.message || 'فشل تحديث طلب الصيانة'));
                    }
                })
                .catch(error => {
                    console.error('Error updating maintenance request:', error);
                    alert('حدث خطأ أثناء تحديث طلب الصيانة: ' + error.message);
                });
            });
        }

        // Reset Filters
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', function() {
                document.getElementById('filterMachine').value = '';
                document.getElementById('filterStatus').value = '';
                document.getElementById('filterLocation').value = '';
                searchInput.value = '';
            });
        }

        // Initialize current date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().slice(0, 10);
            if (document.getElementById('requestDate')) {
                document.getElementById('requestDate').value = today;
            }

            // Delete confirmation
            window.confirmDelete = function(historyID) {
                if (confirm(`Are you sure you want to delete History ${historyID}?`)) {
                    console.log(`MaintenanceHistory ${historyID} deleted`);
                }
            };
        });

        // Search
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                const rows = document.querySelectorAll('#allRequestsTable tbody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(query) ? '' : 'none';
                });
            });
        }
    </script>
</body>
</html>